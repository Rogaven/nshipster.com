<!doctype html>
<html lang="en-US">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  
    <title>guard & defer - NSHipster</title>
    <meta name="description" content="Recently, Swift 2.0 introduced two new control statements that aim to simplify and streamline the programs we write: `guard` and `defer`. While the first by its nature makes our code more linear, the other defers execution of its contents. How should we approach these new control statements? How can `guard` and `defer` help us clarify the correspondence between the program and the process?"/>
    <link rel="canonical" href="http://nshipster.com/guard-and-defer/"/>
  
  
  
  
  <meta name="author" content="Nate Cook"/>
  
  <meta name="revisit-after" content="7 days"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"/>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://nshipster.com/feed.xml"/>
  <link rel="stylesheet" type="text/css" href="http://nshipster.com/css/screen.css"/>
  <link rel="apple-touch-icon" href="/touch-icon-iphone.png"/>
  <link rel="apple-touch-icon" sizes="76x76" href="/touch-icon-ipad.png"/>
  <link rel="apple-touch-icon" sizes="120x120" href="/touch-icon-iphone-retina.png"/>
  <link rel="apple-touch-icon" sizes="152x152" href="/touch-icon-ipad-retina.png"/>
  <link rel="icon" sizes="16x16 24x24 32x32 48x48 64x64" type="image/vnd.microsoft.icon" href="/favicon.ico"/>
  <link rel="mask-icon" sizes="any" href="/website_icon.svg" color="black"/>
  <link rel="author" type="text/plain" href="http://nshipster.com/humans.txt"/>

  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:site" content="@NSHipster"/>
  
  <meta name="twitter:creator" content="@nnnnnnnn"/>
  
  
    <meta name="twitter:title" content="guard & defer"/>
    <meta name="twitter:description" content="Recently, Swift 2.0 introduced two new control statements that aim to simplify and streamline the programs we write: `guard` and `defer`. While the first by its nature makes our code more linear, the other defers execution of its contents. How should we approach these new control statements? How can `guard` and `defer` help us clarify the correspondence between the program and the process?"/>
  
  <meta property="twitter:account_id" content="629523445"/>

  <meta property="og:site_name" content="NSHipster"/>
  <meta property="og:image" content="http://nshipster.com/touch-icon-ipad-retina.png"/>
  
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="guard & defer"/>
    <meta property="og:url" content="http://nshipster.com/guard-and-defer/"/>
    <meta property="og:description" content="Recently, Swift 2.0 introduced two new control statements that aim to simplify and streamline the programs we write: `guard` and `defer`. While the first by its nature makes our code more linear, the other defers execution of its contents. How should we approach these new control statements? How can `guard` and `defer` help us clarify the correspondence between the program and the process?"/>
    <meta property="article:published_time" content="2015-10-05T00:00:00-07:00"/>
    <meta property="article:modified_time" content="2015-12-09T21:34:50-08:00"/>
    <meta property="article:tag" content="swift"/>
    <meta property="article:publisher" content="https://www.facebook.com/NSHipster">
  

  
    <meta property="st:title" content="guard & defer"/>
    <meta property="st:type" content="article"/>
  
  
  <meta property="nshipster:hide-single-lang" content="swift,objective-c"/>
</head>

<body itemscope itemtype="http://schema.org/WebPage">

  <script src="http://nshipster.com/js/zepto.min.js"></script>
  <script src="http://nshipster.com/js/application.js"></script>

  <div role="container">
    <header role="banner">
      <h1 id="logo">
        <a href="/">
          <svg id="ns" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
   viewBox="0 0 79.5 45.7" enable-background="new 0 0 79.5 45.7" xml:space="preserve">
<g>
  <path fill="#F58020" d="M0.6,1h13.7L27,24.4h0.1V1h12.7v43.6H26.8L13.4,20.8h-0.1v23.8H0.6V1z"/>
  <path fill="#F58020" d="M51.4,30c0,1.1,0.2,2.1,0.5,2.9c1,2.6,3.9,3.2,6.4,3.2c2.2,0,5.6-0.7,5.6-4c0-2.3-1.9-2.9-9.4-5
    c-6.9-2-14.8-3.8-14.8-12.6C39.7,4.3,48.3,0,57.3,0c9.5,0,17.8,3.6,18.2,14.2H62.8c0.2-1.6-0.5-2.7-1.6-3.5
    c-1.1-0.8-2.6-1.1-4-1.1c-1.8,0-4.8,0.5-4.8,2.9c0.2,3.1,6.5,3.8,12.6,5.5c6.2,1.7,12.3,4.6,12.3,12.6c0,11.4-10.4,15-20.1,15
    c-4.9,0-19-1.8-19.2-15.7H51.4z"/>
</g>
</svg>

          <svg id="mustache" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
   viewBox="0 0 79.5 45.7" enable-background="new 0 0 79.5 45.7" xml:space="preserve">
  <g transform="translate(0,-952.36217)" opacity="0.95">
    <path id="path2987" fill="#010101" d="M28.2,971.4c-10,0.5-19.1,13.3-28.2,2.1c0,15.1,23.7,30.5,39.8,16.3
      c16,14.1,39.8-1.3,39.8-16.3c-12.5,15.4-25-14.4-39.8,4.5C35.8,972.7,31.9,971.2,28.2,971.4z"/>
  </g>
</svg>

        </a>

        <span hidden style="display:none;">NSHipster</span>
      </h1>

      <form role="search">
        <input type="text" id="st-search-input" class="st-search-input" />
      </form>

      
    </header>

    <div id="main" role="main" itemprop="mainContentOfPage">
      

<article role="article" itemscope itemtype="http://schema.org/Article">
  <header role="heading">
    <h1 class="title" itemprop="name">
      <a href="/guard-and-defer/">guard & defer</a>
    </h1>

    <h2>
    
      Written by <a class="author" href="/authors/nate-cook/">Nate Cook</a> —
    
    <time datetime="2015-10-05T00:00:00-07:00" itemprop="datePublished">October 5<sup>th</sup>, 2015</time>
    
    </h2>

  </header>

  <div class="content" itemprop="articleBody" data-swiftype-index="true">
    <blockquote>
<p>&ldquo;We should do (as wise programmers aware of our limitations) our utmost best to … make the correspondence between the program (spread out in text space) and the process (spread out in time) as trivial as possible.&rdquo;</p>

<p>—<a href="https://en.wikipedia.org/wiki/Edsger_W._Dijkstra">Edsger W. Dijkstra</a>, &ldquo;Go To Considered Harmful&rdquo;</p>
</blockquote>

<p>Recently, Swift 2.0 introduced two new control statements that aim to simplify and streamline the programs we write: <code>guard</code> and <code>defer</code>. While the first by its nature makes our code more linear, the other defers execution of its contents. How should we approach these new control statements? How can <code>guard</code> and <code>defer</code> help us clarify the correspondence between the program and the process?</p>

<p>Let&rsquo;s defer <code>defer</code> and first take on <code>guard</code>.</p>

<hr>

<h2 id="guard">guard</h2>

<p>If the multiple optional bindings syntax introduced in <a href="/swift-1.2/">Swift 1.2</a> heralded a renovation of the <a href="http://www.scottlogic.com/blog/2014/12/08/swift-optional-pyramids-of-doom.html">pyramid of doom</a>, <code>guard</code> statements tear it down altogether.</p>

<p><code>guard</code> is a new conditional statement that requires execution to exit the current block if the condition isn&rsquo;t met. Any new optional bindings created in a <code>guard</code> statement&rsquo;s condition are available for the rest of the function or block, and the mandatory <code>else</code> must exit the current scope, by using <code>return</code> to leave a function, <code>continue</code> or <code>break</code> within a loop, or a <code>@noreturn</code> function like <code>fatalError()</code>:</p>
<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">for</span> <span class="n">imageName</span> <span class="k">in</span> <span class="n">imageNamesList</span> <span class="p">{</span>
    <span class="kr">guard</span> <span class="k">let</span> <span class="n">image</span> <span class="o">=</span> <span class="bp">UIImage</span><span class="p">(</span><span class="nl">named</span><span class="p">:</span> <span class="n">imageName</span><span class="p">)</span> 
        <span class="k">else</span> <span class="p">{</span> <span class="k">continue</span> <span class="p">}</span>

    <span class="c1">// do something with image</span>
<span class="p">}</span>
</code></pre></div>
<p>Let&rsquo;s take a before-and-after look at how <code>guard</code> can improve our code and help prevent errors. As an example, we&rsquo;ll build a new string-to-<code>UInt8</code> initializer. <code>UInt8</code> already declares a failable initializer that takes a <code>String</code>, but if the conversion fails we don&rsquo;t learn the reason—was the format invalid or was the value out of bounds for the numeric type? Our new initializer throws a <code>ConversionError</code> that provides more information.</p>
<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">enum</span> <span class="nl">ConversionError</span> <span class="p">:</span> <span class="n">ErrorType</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">InvalidFormat</span><span class="p">,</span> <span class="n">OutOfBounds</span><span class="p">,</span> <span class="n">Unknown</span>
<span class="p">}</span>

<span class="k">extension</span> <span class="kt">UInt8</span> <span class="p">{</span>
    <span class="k">init</span><span class="p">(</span><span class="n">fromString</span> <span class="nl">string</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">{</span>
        <span class="c1">// check the string&#39;s format</span>
        <span class="k">if</span> <span class="k">let</span> <span class="n">_</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">rangeOfString</span><span class="p">(</span><span class="s">&quot;^</span><span class="se">\\</span><span class="s">d+$&quot;</span><span class="p">,</span> <span class="nl">options</span><span class="p">:</span> <span class="p">[.</span><span class="n">RegularExpressionSearch</span><span class="p">])</span> <span class="p">{</span>

            <span class="c1">// make sure the value is in bounds</span>
            <span class="k">if</span> <span class="n">string</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;\(UInt8.max)&quot;</span><span class="p">,</span> <span class="nl">options</span><span class="p">:</span> <span class="p">[.</span><span class="n">NumericSearch</span><span class="p">])</span> <span class="o">!=</span> <span class="n">NSComparisonResult</span><span class="p">.</span><span class="n">OrderedAscending</span> <span class="p">{</span>
                <span class="kr">throw</span> <span class="n">ConversionError</span><span class="p">.</span><span class="n">OutOfBounds</span>
            <span class="p">}</span>

            <span class="c1">// do the built-in conversion</span>
            <span class="k">if</span> <span class="k">let</span> <span class="n">value</span> <span class="o">=</span> <span class="kt">UInt8</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="p">{</span>
                <span class="nb">self</span><span class="p">.</span><span class="k">init</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="kr">throw</span> <span class="n">ConversionError</span><span class="p">.</span><span class="n">Unknown</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="kr">throw</span> <span class="n">ConversionError</span><span class="p">.</span><span class="n">InvalidFormat</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Note how far apart the format check and the invalid format <code>throw</code> are in this example. Not ideal. Moreover, the actual initialization happens two levels deep, inside a nested <code>if</code> statement. And if that isn&rsquo;t enough, there&rsquo;s a bug in the logic of this initializer that isn&rsquo;t immediately apparent. Can you spot the flaw? What&rsquo;s really going to bake your noodle later on is, would you still have noticed it if I hadn&rsquo;t said anything?</p>

<p>Next, let&rsquo;s take a look at how using <code>guard</code> transforms this initializer:</p>
<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">extension</span> <span class="kt">UInt8</span> <span class="p">{</span>
    <span class="k">init</span><span class="p">(</span><span class="n">fromString</span> <span class="nl">string</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">{</span>
        <span class="c1">// check the string&#39;s format</span>
        <span class="kr">guard</span> <span class="k">let</span> <span class="n">_</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">rangeOfString</span><span class="p">(</span><span class="s">&quot;^</span><span class="se">\\</span><span class="s">d+$&quot;</span><span class="p">,</span> <span class="nl">options</span><span class="p">:</span> <span class="p">[.</span><span class="n">RegularExpressionSearch</span><span class="p">])</span> 
            <span class="k">else</span> <span class="p">{</span> <span class="kr">throw</span> <span class="n">ConversionError</span><span class="p">.</span><span class="n">InvalidFormat</span> <span class="p">}</span>

        <span class="c1">// make sure the value is in bounds</span>
        <span class="kr">guard</span> <span class="n">string</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;\(UInt8.max)&quot;</span><span class="p">,</span> <span class="nl">options</span><span class="p">:</span> <span class="p">[.</span><span class="n">NumericSearch</span><span class="p">])</span> <span class="o">!=</span> <span class="n">NSComparisonResult</span><span class="p">.</span><span class="n">OrderedDescending</span> 
            <span class="k">else</span> <span class="p">{</span> <span class="kr">throw</span> <span class="n">ConversionError</span><span class="p">.</span><span class="n">OutOfBounds</span> <span class="p">}</span>

        <span class="c1">// do the built-in conversion</span>
        <span class="kr">guard</span> <span class="k">let</span> <span class="n">value</span> <span class="o">=</span> <span class="n">UInt</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> 
            <span class="k">else</span> <span class="p">{</span> <span class="kr">throw</span> <span class="n">ConversionError</span><span class="p">.</span><span class="n">Unknown</span> <span class="p">}</span>

        <span class="nb">self</span><span class="p">.</span><span class="k">init</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Much better. Each error case is handled as soon as it has been checked, so we can follow the flow of execution straight down the left-hand side. </p>

<p>Even more importantly, using <code>guard</code> prevents the logic flaw in our first attempt: that final <code>throw</code> is called every time because it isn&rsquo;t enclosed in an <code>else</code> statement. With <code>guard</code>, the compiler forces us to break scope inside the else-block, guaranteeing the execution of that particular <code>throw</code> only at the right times.</p>

<p>Also note that the middle <code>guard</code> statement isn&rsquo;t strictly necessary. Since it doesn&rsquo;t unwrap an optional value, an <code>if</code> statement would work perfectly well. Using <code>guard</code> in this case simply provides an extra layer of safety—the compiler ensures that you leave the initializer if the test fails, leaving no way to accidentally comment out the <code>throw</code> or introduce another error that would lose part of the initializer&rsquo;s logic.</p>

<h2 id="defer">defer</h2>

<p>Between <code>guard</code> and the new <code>throw</code> statement for error handling, Swift 2.0 certainly seems to be encouraging a style of early return (an NSHipster favorite) rather than nested <code>if</code> statements. Returning early poses a distinct challenge, however, when resources that have been initialized (and may still be in use) must be cleaned up before returning.</p>

<p>The new <code>defer</code> keyword provides a safe and easy way to handle this challenge by declaring a block that will be executed only when execution leaves the current scope. Consider this snippet of a function working with <code>vImage</code> from the Accelerate framework, taken from the newly-updated article on <a href="/image-resizing/">image resizing</a>:</p>
<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">func</span> <span class="n">resizeImage</span><span class="p">(</span><span class="nl">url</span><span class="p">:</span> <span class="bp">NSURL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">UIImage</span><span class="o">?</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">let</span> <span class="nl">dataSize</span><span class="p">:</span> <span class="n">Int</span> <span class="o">=</span> <span class="p">...</span>
    <span class="k">let</span> <span class="n">destData</span> <span class="o">=</span> <span class="n">UnsafeMutablePointer</span><span class="o">&lt;</span><span class="kt">UInt8</span><span class="o">&gt;</span><span class="p">.</span><span class="n">alloc</span><span class="p">(</span><span class="n">dataSize</span><span class="p">)</span>
    <span class="k">var</span> <span class="n">destBuffer</span> <span class="o">=</span> <span class="n">vImage_Buffer</span><span class="p">(</span><span class="nl">data</span><span class="p">:</span> <span class="n">destData</span><span class="p">,</span> <span class="p">...)</span>

    <span class="c1">// scale the image from sourceBuffer to destBuffer</span>
    <span class="k">var</span> <span class="n">error</span> <span class="o">=</span> <span class="n">vImageScale_ARGB8888</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sourceBuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">destBuffer</span><span class="p">,</span> <span class="p">...)</span>
    <span class="kr">guard</span> <span class="n">error</span> <span class="o">==</span> <span class="n">kvImageNoError</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">destData</span><span class="p">.</span><span class="n">dealloc</span><span class="p">(</span><span class="n">dataSize</span><span class="p">)</span>  <span class="c1">// 1</span>
            <span class="k">return</span> <span class="nb">nil</span>
        <span class="p">}</span>

    <span class="c1">// create a CGImage from the destBuffer</span>
    <span class="kr">guard</span> <span class="k">let</span> <span class="n">destCGImage</span> <span class="o">=</span> <span class="n">vImageCreateCGImageFromBuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">destBuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span> 
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">destData</span><span class="p">.</span><span class="n">dealloc</span><span class="p">(</span><span class="n">dataSize</span><span class="p">)</span>  <span class="c1">// 2</span>
            <span class="k">return</span> <span class="nb">nil</span>
        <span class="p">}</span>
    <span class="n">destData</span><span class="p">.</span><span class="n">dealloc</span><span class="p">(</span><span class="n">dataSize</span><span class="p">)</span>          <span class="c1">// 3</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<p>Here an <code>UnsafeMutablePointer&lt;UInt8&gt;</code> is allocated for the destination data early on, but we need to remember to deallocate at both failure points <em>and</em> once we no longer need the pointer.</p>

<p>Error prone? Yes. Frustratingly repetitive? Check.</p>

<p>A <code>defer</code> statement removes any chance of forgetting to clean up after ourselves while also simplifying our code. Even though the <code>defer</code> block comes immediately after the call to <code>alloc()</code>, its execution is delayed until the end of the current scope:</p>
<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">func</span> <span class="n">resizeImage</span><span class="p">(</span><span class="nl">url</span><span class="p">:</span> <span class="bp">NSURL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">UIImage</span><span class="o">?</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">let</span> <span class="nl">dataSize</span><span class="p">:</span> <span class="n">Int</span> <span class="o">=</span> <span class="p">...</span>
    <span class="k">let</span> <span class="n">destData</span> <span class="o">=</span> <span class="n">UnsafeMutablePointer</span><span class="o">&lt;</span><span class="kt">UInt8</span><span class="o">&gt;</span><span class="p">.</span><span class="n">alloc</span><span class="p">(</span><span class="n">dataSize</span><span class="p">)</span>
    <span class="kr">defer</span> <span class="p">{</span>
        <span class="n">destData</span><span class="p">.</span><span class="n">dealloc</span><span class="p">(</span><span class="n">dataSize</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">var</span> <span class="n">destBuffer</span> <span class="o">=</span> <span class="n">vImage_Buffer</span><span class="p">(</span><span class="nl">data</span><span class="p">:</span> <span class="n">destData</span><span class="p">,</span> <span class="p">...)</span>

    <span class="c1">// scale the image from sourceBuffer to destBuffer</span>
    <span class="k">var</span> <span class="n">error</span> <span class="o">=</span> <span class="n">vImageScale_ARGB8888</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sourceBuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">destBuffer</span><span class="p">,</span> <span class="p">...)</span>
    <span class="kr">guard</span> <span class="n">error</span> <span class="o">==</span> <span class="n">kvImageNoError</span> 
        <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">nil</span> <span class="p">}</span>

    <span class="c1">// create a CGImage from the destBuffer</span>
    <span class="kr">guard</span> <span class="k">let</span> <span class="n">destCGImage</span> <span class="o">=</span> <span class="n">vImageCreateCGImageFromBuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">destBuffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span> 
        <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">nil</span> <span class="p">}</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<p>Thanks to <code>defer</code>, <code>destData</code> will be properly deallocated no matter which exit point is used to return from the function.</p>

<p>Safe and clean. Swift at its best.</p>

<blockquote>
<p><code>defer</code> blocks are executed in the reverse order of their appearance. This reverse order is a vital detail, ensuring everything that was in scope when a deferred block was created will still be in scope when the block is executed.</p>
</blockquote>

<h3 id="(any-other)-defer-considered-harmful">(Any Other) Defer Considered Harmful</h3>

<p>As handy as the <code>defer</code> statement is, be aware of how its capabilities can lead to confusing, untraceable code. It may be tempting to use <code>defer</code> in cases where a function needs to return a value that should also be modified, as in this typical implementation of the postfix <code>++</code> operator:</p>
<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kr">postfix</span> <span class="k">func</span> <span class="o">++</span><span class="p">(</span><span class="k">inout</span> <span class="nl">x</span><span class="p">:</span> <span class="n">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Int</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">current</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">current</span>
<span class="p">}</span>
</code></pre></div>
<p>In this case, <code>defer</code> offers a clever alternative. Why create a temporary variable when we can just defer the increment? </p>
<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kr">postfix</span> <span class="k">func</span> <span class="o">++</span><span class="p">(</span><span class="k">inout</span> <span class="nl">x</span><span class="p">:</span> <span class="n">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Int</span> <span class="p">{</span>
    <span class="kr">defer</span> <span class="p">{</span> <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">}</span>
    <span class="k">return</span> <span class="n">x</span>
<span class="p">}</span>
</code></pre></div>
<p>Clever indeed, yet this inversion of the function&rsquo;s flow harms readability. Using <code>defer</code> to explicitly alter a program&rsquo;s flow, rather than to clean up allocated resources, will lead to a twisted and tangled execution process.</p>

<hr>

<p>&ldquo;As wise programmers aware of our limitations,&rdquo; we must weigh the benefits of each language feature against its costs. A new statement like <code>guard</code> leads to a more linear, more readable program; apply it as widely as possible. Likewise, <code>defer</code> solves a significant challenge but forces us to keep track of its declaration as it scrolls out of sight; reserve it for its minimum intended purpose to guard against confusion and obscurity.</p>

  </div>

  <footer role="complementary">
    
    <section id="revisions">
      <small>NSMutableHipster</small>

      <p>
      Questions? Corrections?  <a href="https://github.com/NSHipster/articles/issues">Issues</a> and <a href="https://github.com/NSHipster/articles/blob/master/2015-10-05-guard-and-defer.md">pull requests</a> are always welcome — NSHipster is made better by readers like you.
      </p>
      
      <p>
      
        
            <em>This article uses Swift version 2.0.</em>
        
      
      Find status information for all articles on the <a href="/status/">status page</a>.
      </p>
      
      <dl>
      
      </dl>
    </section>
    

    <section id="follow">
      <small>Follow NSHipster</small>

      <ul>
        <li class="twitter">
          <a href="https://twitter.com/intent/user?screen_name=NSHipster" title="Follow NSHipster on Twitter"><i class="icon-twitter" aria-hidden="true"></i></a>
        </li>
        <li class="facebook">
          <a href="https://www.facebook.com/NSHipster" title="Like NSHipster on Facebook"><i class="icon-facebook" aria-hidden="true"></i></a>
        </li>
        <li class="google-plus">
          <a href="https://plus.google.com/+NSHipster" title="Follow NSHipster on G+"><i class="icon-googleplus" aria-hidden="true"></i></a>
        </li>
        <li class="rss">
          <a href="/feed.xml" title="Subscribe to the NSHipster RSS Feed"><i class="icon-feed" aria-hidden="true"></i></a>
        </li>
      </ul>

      <form action="https://tinyletter.com/NSHipster" method="post" target="popupwindow" onsubmit="window.open('https://tinyletter.com/NSHipster', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true">
        <label for="tlemail" hidden style="display:none;">Enter Your Email Address</label>
        <input type="email" name="email" id="tlemail" placeholder="Your Email Address"/>
        <input type="hidden" name="embed" value="1"/>
        <input type="submit" value="Join the Newsletter"/>
      </form>
    </section>

    <section id="attribution">
      
  <div class="contributor" itemprop="author" itemscope itemtype="http://data-vocabulary.org/Person">
    <small>Written by</small>

    <img class="avatar" alt="Nate Cook" itemprop="image" src="http://nshipster.s3.amazonaws.com/nate-cook.jpg" draggable="false"/>
    <div class="details">
      <span itemprop="name"><a href="/authors/nate-cook/">Nate Cook</a></span>

      <p><a href="http://natecook.com">Nate Cook</a> (<a href="https://twitter.com/nnnnnnnn">@nnnnnnnn</a>) is an independent web and application developer who <a href="http://natecook.com/blog/">writes frequently about topics in Swift</a>, and the creator of <a href="http://swiftdoc.org">SwiftDoc.org</a>.</p>


      
        <a href="https://plus.google.com/?rel=author" rel="author"></a>
      
    </div>
  </div>


    </section>

    

    

    <section>
      <div id="continue">
        <small>Next Article</small>
        
        
        
        

          <article>
            <h1 class="title">
              <a href="/ios8/" title="iOS 8" rel="next">i​OS 8</a>
            </h1>

            <p>Ask anyone, and they&rsquo;ll tell you: WWDC 2014 was the one of the most exciting in recent memory. This week, we&rsquo;ll take a look beneath the headline features, and share some of the more obscure APIs that everyone should know about.</p>

          </article>
      </div>

      
      
        
        
      

      <div id="related">
        <small>Related Articles</small>

        <ul>
          
          
          
            <li>
              <a href="/swift-operators/" title="Swift Operators">Swift Operators</a>
            </li>
            
          
          
            <li>
              <a href="/swift-literal-convertible/" title="Swift Literal Convertibles">Swift Literal Convertibles</a>
            </li>
            
          
          
          
          
            <li>
              <a href="/swift-collection-protocols/" title="Swift Collection Protocols">Swift Collection Protocols</a>
            </li>
            
          
        </ul>
      </div>
    </section>
  </footer>
</article>

    </div>

    <footer role="contentinfo">
      <section class="credits colophon">
        <p>
          Questions? Corrections? <a href="https://twitter.com/NSHipster">@NSHipster</a> or <a href="https://github.com/NSHipster/articles">on GitHub</a>.
        </p>
        <p>
          <i aria-hidden="true" class="icon-cc"></i>
          <i aria-hidden="true" class="icon-cc-by"></i>
          <i aria-hidden="true" class="icon-cc-nc"></i>
          NSHipster.com is released under a <a href="http://creativecommons.org/licenses/by-nc/4.0/" rel="license">Creative Commons BY-NC License</a>.
        </p>
        <p><abbr title="International Standard Serial Number">ISSN</abbr> 2373-9800</p>
        <p lang="zh-Hans"><a href="http://nshipster.cn" hreflang="zh-Hans" title="Articles also available in Chinese">文章也可在中文版阅读</a>。</p>
        <a href="https://plus.google.com/105091289906267717942" rel="publisher"></a>
      </section>
    </footer>
  </div>

  <script>
    if (window.navigator && window.navigator.loadPurpose === "preview") {
      window.location.href = "http://nshipster.com/topsites_preview.html";
    }
  </script>

  <script async>
    var Swiftype = window.Swiftype || {};
    (function() {
      Swiftype.key = 'Q5jNBiR8qVs5xE5dNect';
      var script = document.createElement('script');
      script.type = 'text/javascript';
      script.async = true;
      script.src = "//swiftype.com/embed.js";
      var entry = document.getElementsByTagName('script')[0];
      document.getElementsByTagName('script')[0].parentNode.insertBefore(script, entry);
    }());
  </script>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-49868484-1', 'nshipster.com');
    ga('send', 'pageview');
  </script>

</body>
</html>
