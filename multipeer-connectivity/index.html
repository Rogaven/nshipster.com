<!doctype html>
<html lang="en-US">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  
    <title>Multipeer Connectivity - NSHipster</title>
    <meta name="description" content="As consumer web technologies and enterprises race towards cloud infrastructure, there is a curious and significant counter-movement towards connected devices. The Multipeer Connectivity APIs, introduced in iOS 7, therefore may well be the most significant for the platform."/>
    <link rel="canonical" href="http://nshipster.com/multipeer-connectivity/"/>
  
  
  
  
  <meta name="author" content="Mattt Thompson"/>
  
  <meta name="revisit-after" content="7 days"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"/>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://nshipster.com/feed.xml"/>
  <link rel="stylesheet" type="text/css" href="http://nshipster.com/css/screen.css"/>
  <link rel="apple-touch-icon" href="/touch-icon-iphone.png"/>
  <link rel="apple-touch-icon" sizes="76x76" href="/touch-icon-ipad.png"/>
  <link rel="apple-touch-icon" sizes="120x120" href="/touch-icon-iphone-retina.png"/>
  <link rel="apple-touch-icon" sizes="152x152" href="/touch-icon-ipad-retina.png"/>
  <link rel="icon" sizes="16x16 24x24 32x32 48x48 64x64" type="image/vnd.microsoft.icon" href="/favicon.ico"/>
  <link rel="mask-icon" sizes="any" href="/website_icon.svg" color="black"/>
  <link rel="author" type="text/plain" href="http://nshipster.com/humans.txt"/>

  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:site" content="@NSHipster"/>
  
  <meta name="twitter:creator" content="@mattt"/>
  
  
    <meta name="twitter:title" content="Multipeer Connectivity"/>
    <meta name="twitter:description" content="As consumer web technologies and enterprises race towards cloud infrastructure, there is a curious and significant counter-movement towards connected devices. The Multipeer Connectivity APIs, introduced in iOS 7, therefore may well be the most significant for the platform."/>
  
  <meta property="twitter:account_id" content="629523445"/>

  <meta property="og:site_name" content="NSHipster"/>
  <meta property="og:image" content="http://nshipster.com/touch-icon-ipad-retina.png"/>
  
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Multipeer Connectivity"/>
    <meta property="og:url" content="http://nshipster.com/multipeer-connectivity/"/>
    <meta property="og:description" content="As consumer web technologies and enterprises race towards cloud infrastructure, there is a curious and significant counter-movement towards connected devices. The Multipeer Connectivity APIs, introduced in iOS 7, therefore may well be the most significant for the platform."/>
    <meta property="article:published_time" content="2013-12-09T00:00:00-08:00"/>
    <meta property="article:modified_time" content="2015-12-09T21:34:50-08:00"/>
    <meta property="article:tag" content="cocoa"/>
    <meta property="article:publisher" content="https://www.facebook.com/NSHipster">
  

  
    <meta property="st:title" content="Multipeer Connectivity"/>
    <meta property="st:type" content="article"/>
  
  
  <meta property="nshipster:hide-single-lang" content="swift,objective-c"/>
</head>

<body itemscope itemtype="http://schema.org/WebPage">

  <script src="http://nshipster.com/js/zepto.min.js"></script>
  <script src="http://nshipster.com/js/application.js"></script>

  <div role="container">
    <header role="banner">
      <h1 id="logo">
        <a href="/">
          <svg id="ns" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
   viewBox="0 0 79.5 45.7" enable-background="new 0 0 79.5 45.7" xml:space="preserve">
<g>
  <path fill="#F58020" d="M0.6,1h13.7L27,24.4h0.1V1h12.7v43.6H26.8L13.4,20.8h-0.1v23.8H0.6V1z"/>
  <path fill="#F58020" d="M51.4,30c0,1.1,0.2,2.1,0.5,2.9c1,2.6,3.9,3.2,6.4,3.2c2.2,0,5.6-0.7,5.6-4c0-2.3-1.9-2.9-9.4-5
    c-6.9-2-14.8-3.8-14.8-12.6C39.7,4.3,48.3,0,57.3,0c9.5,0,17.8,3.6,18.2,14.2H62.8c0.2-1.6-0.5-2.7-1.6-3.5
    c-1.1-0.8-2.6-1.1-4-1.1c-1.8,0-4.8,0.5-4.8,2.9c0.2,3.1,6.5,3.8,12.6,5.5c6.2,1.7,12.3,4.6,12.3,12.6c0,11.4-10.4,15-20.1,15
    c-4.9,0-19-1.8-19.2-15.7H51.4z"/>
</g>
</svg>

          <svg id="mustache" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
   viewBox="0 0 79.5 45.7" enable-background="new 0 0 79.5 45.7" xml:space="preserve">
  <g transform="translate(0,-952.36217)" opacity="0.95">
    <path id="path2987" fill="#010101" d="M28.2,971.4c-10,0.5-19.1,13.3-28.2,2.1c0,15.1,23.7,30.5,39.8,16.3
      c16,14.1,39.8-1.3,39.8-16.3c-12.5,15.4-25-14.4-39.8,4.5C35.8,972.7,31.9,971.2,28.2,971.4z"/>
  </g>
</svg>

        </a>

        <span hidden style="display:none;">NSHipster</span>
      </h1>

      <form role="search">
        <input type="text" id="st-search-input" class="st-search-input" />
      </form>

      
    </header>

    <div id="main" role="main" itemprop="mainContentOfPage">
      

<article role="article" itemscope itemtype="http://schema.org/Article">
  <header role="heading">
    <h1 class="title" itemprop="name">
      <a href="/multipeer-connectivity/">Multipeer Connectivity</a>
    </h1>

    <h2>
    
      Written by <a class="author" href="/authors/mattt-thompson/">Mattt Thompson</a> —
    
    <time datetime="2013-12-09T00:00:00-08:00" itemprop="datePublished">December 9<sup>th</sup>, 2013</time>
    
    </h2>

  </header>

  <div class="content" itemprop="articleBody" data-swiftype-index="true">
    <p>As consumer web technologies and enterprises race towards cloud infrastructure, there is a curious and significant counter-movement towards connected devices.</p>

<p>In this age of mobile computing, the possibilities of collaboration, whether in work or play, have never been greater. In this age of privacy concerns and mass surveillance, the need for secure, ad hoc communications has never been more prescient. In this age of connected devices, the promise of mastery over the everyday objects of our lives has never been closer at hand.</p>

<p>The Multipeer Connectivity APIs, introduced in iOS 7, therefore may well be the most significant for the platform. It allows developers to completely reimagine how mobile apps are built, and to redefine what is possible. And we&rsquo;re not just talking about successors to the lame bump-to-send-contact-information genre, either: multi-peer connectivity has implications on everything from collaborative editing and file sharing to multiplayer gaming and sensor aggregation.</p>

<hr>

<p>Multipeer Connectivity is a framework that enables nearby devices to communicate over infrastructure Wi-Fi networks, peer-to-peer Wi-Fi, and Bluetooth personal area networks. Connected peers are able securely transmit messages, streams, or file resources to other devices without going through an intermediary web service.</p>

<h2 id="advertising-&amp;-discovering">Advertising &amp; Discovering</h2>

<p>The first step in communication is to make peers aware of one another. This is accomplished by advertising and discovering services.</p>

<p>Advertising makes a service known to other peers, while discovery is the inverse process of the client being made aware of services advertised by other peers. In many cases, clients both discover and advertise for the same service, which can lead to some initial confusion—especially to anyone rooted in the client-server paradigm.</p>

<p>Each service is identified by a type, which is a short text string of ASCII letters, numbers, and dashes, up to 15 characters in length. By convention, a service name should begin with the app name, followed by a dash and a unique descriptor for that service (think of it as simplified <code>com.apple.*</code>-esque reverse-DNS notation):</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="k">static</span> <span class="bp">NSString</span> <span class="o">*</span> <span class="k">const</span> <span class="n">XXServiceType</span> <span class="o">=</span> <span class="s">@&quot;xx-service&quot;</span><span class="p">;</span>
</code></pre></div>
<p>Peers are uniquely identified by an <code>MCPeerID</code> object, which are initialized with a display name. This could be a user-specified nickname, or simply the current device name:</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="bp">MCPeerID</span> <span class="o">*</span><span class="n">localPeerID</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">MCPeerID</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithDisplayName</span><span class="p">:[[</span><span class="bp">UIDevice</span> <span class="n">currentDevice</span><span class="p">]</span> <span class="n">name</span><span class="p">]];</span>
</code></pre></div>
<blockquote>
<p>Peers can be also be advertised or discovered manually using <code>NSNetService</code> or the Bonjour C APIs, but this is a rather advanced and specific concern. Additional information about manual peer management can be found in the <code>MCSession</code> documentation.</p>
</blockquote>

<h3 id="advertising">Advertising</h3>

<p>Services are advertised by the <code>MCNearbyServiceAdvertiser</code>, which is initialized with a local peer, service type, and any optional information to be communicated to peers that discover the service.</p>

<blockquote>
<p>Discovery information is sent as Bonjour <code>TXT</code> records encoded according to <a href="http://tools.ietf.org/html/rfc6763">RFC 6763</a>.</p>
</blockquote>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="bp">MCNearbyServiceAdvertiser</span> <span class="o">*</span><span class="n">advertiser</span> <span class="o">=</span>
    <span class="p">[[</span><span class="bp">MCNearbyServiceAdvertiser</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithPeer</span><span class="p">:</span><span class="n">localPeerID</span>
                                      <span class="nl">discoveryInfo</span><span class="p">:</span><span class="nb">nil</span>
                                        <span class="nl">serviceType</span><span class="p">:</span><span class="n">XXServiceType</span><span class="p">];</span>
<span class="n">advertiser</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
<span class="p">[</span><span class="n">advertiser</span> <span class="n">startAdvertisingPeer</span><span class="p">];</span>
</code></pre></div>
<p>Events are handled by the advertiser&rsquo;s <code>delegate</code>, conforming to the <code>MCNearbyServiceAdvertiserDelegate</code> protocol.</p>

<p>As an example implementation, consider a client that allows the user to choose whether to accept or reject incoming connection requests, with the option to reject and block any subsequent requests from that peer:</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="cp">#pragma mark - MCNearbyServiceAdvertiserDelegate</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">advertiser:</span><span class="p">(</span><span class="bp">MCNearbyServiceAdvertiser</span> <span class="o">*</span><span class="p">)</span><span class="nv">advertiser</span>
<span class="nf">didReceiveInvitationFromPeer:</span><span class="p">(</span><span class="bp">MCPeerID</span> <span class="o">*</span><span class="p">)</span><span class="nv">peerID</span>
       <span class="nf">withContext:</span><span class="p">(</span><span class="bp">NSData</span> <span class="o">*</span><span class="p">)</span><span class="nv">context</span>
 <span class="nf">invitationHandler:</span><span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="kt">BOOL</span> <span class="n">accept</span><span class="p">,</span> <span class="bp">MCSession</span> <span class="o">*</span><span class="n">session</span><span class="p">))</span><span class="nv">invitationHandler</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">([</span><span class="nb">self</span><span class="p">.</span><span class="n">mutableBlockedPeers</span> <span class="nl">containsObject</span><span class="p">:</span><span class="n">peerID</span><span class="p">])</span> <span class="p">{</span>
        <span class="n">invitationHandler</span><span class="p">(</span><span class="nb">NO</span><span class="p">,</span> <span class="nb">nil</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">[[</span><span class="bp">UIActionSheet</span> <span class="nl">actionSheetWithTitle</span><span class="p">:[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="n">NSLocalizedString</span><span class="p">(</span><span class="s">@&quot;Received Invitation from %@&quot;</span><span class="p">,</span> <span class="s">@&quot;Received Invitation from {Peer}&quot;</span><span class="p">),</span> <span class="n">peerID</span><span class="p">.</span><span class="n">displayName</span><span class="p">]</span>
                       <span class="nl">cancelButtonTitle</span><span class="p">:</span><span class="n">NSLocalizedString</span><span class="p">(</span><span class="s">@&quot;Reject&quot;</span><span class="p">,</span> <span class="nb">nil</span><span class="p">)</span>
                  <span class="nl">destructiveButtonTitle</span><span class="p">:</span><span class="n">NSLocalizedString</span><span class="p">(</span><span class="s">@&quot;Block&quot;</span><span class="p">,</span> <span class="nb">nil</span><span class="p">)</span>
                       <span class="nl">otherButtonTitles</span><span class="p">:</span><span class="l">@[</span><span class="n">NSLocalizedString</span><span class="p">(</span><span class="s">@&quot;Accept&quot;</span><span class="p">,</span> <span class="nb">nil</span><span class="p">)</span><span class="l">]</span>
                                   <span class="nl">block</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">UIActionSheet</span> <span class="o">*</span><span class="n">actionSheet</span><span class="p">,</span> <span class="bp">NSInteger</span> <span class="n">buttonIndex</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">BOOL</span> <span class="n">acceptedInvitation</span> <span class="o">=</span> <span class="p">(</span><span class="n">buttonIndex</span> <span class="o">==</span> <span class="p">[</span><span class="n">actionSheet</span> <span class="n">firstOtherButtonIndex</span><span class="p">]);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">buttonIndex</span> <span class="o">==</span> <span class="p">[</span><span class="n">actionSheet</span> <span class="n">destructiveButtonIndex</span><span class="p">])</span> <span class="p">{</span>
            <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">mutableBlockedPeers</span> <span class="nl">addObject</span><span class="p">:</span><span class="n">peerID</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="bp">MCSession</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">MCSession</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithPeer</span><span class="p">:</span><span class="n">localPeerID</span>
                                            <span class="nl">securityIdentity</span><span class="p">:</span><span class="nb">nil</span>
                                        <span class="nl">encryptionPreference</span><span class="p">:</span><span class="n">MCEncryptionNone</span><span class="p">];</span>
        <span class="n">session</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>

        <span class="n">invitationHandler</span><span class="p">(</span><span class="n">acceptedInvitation</span><span class="p">,</span> <span class="p">(</span><span class="n">acceptedInvitation</span> <span class="o">?</span> <span class="nl">session</span> <span class="p">:</span> <span class="nb">nil</span><span class="p">));</span>
    <span class="p">}]</span> <span class="nl">showInView</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">view</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>For sake of simplicity, this example contrives a block-based initializer for <code>UIActionSheet</code>, which allows for the <code>invitationHandler</code> to be passed directly into the action sheet responder in order to avoid the messy business of creating and managing a custom delegate object. This method can be implemented in a category, or adapted from <a href="http://cocoapods.org/?q=uiactionsheet%20blocks">any of the implementations available on CocoaPods</a></p>
</blockquote>

<h3 id="creating-a-session">Creating a Session</h3>

<p>As in the example above, sessions are created by advertisers, and passed to peers when accepting an invitation to connect. An <code>MCSession</code> object is initialized with the local peer identifier, as well as <code>securityIdentity</code> and <code>encryptionPreference</code> parameters.</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="bp">MCSession</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">MCSession</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithPeer</span><span class="p">:</span><span class="n">localPeerID</span>
                                    <span class="nl">securityIdentity</span><span class="p">:</span><span class="nb">nil</span>
                                <span class="nl">encryptionPreference</span><span class="p">:</span><span class="n">MCEncryptionNone</span><span class="p">];</span>
<span class="n">session</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
</code></pre></div>
<p><code>securityIdentity</code> is an optional parameter that allows peers to securely identify peers by X.509 certificates. When specified, the first object should be an <code>SecIdentityRef</code> identifying the client, followed by one or more <code>SecCertificateRef</code> objects than can be used to verify the local peer’s identity.</p>

<p>The <code>encryptionPreference</code> parameter specifies whether to encrypt communication between peers. Three possible values are provided by the <code>MCEncryptionPreference</code> enum:</p>

<ul>
<li><code>MCEncryptionOptional</code>: The session prefers to use encryption, but will accept unencrypted connections.</li>
<li><code>MCEncryptionRequired</code>: The session requires encryption.</li>
<li><code>MCEncryptionNone</code>: The session should not be encrypted.</li>
</ul>

<blockquote>
<p>Enabling encryption can significantly reduce transfer rates, so unless your application specifically deals with user-sensitive information, <code>MCEncryptionNone</code> is recommended.</p>
</blockquote>

<p>The <code>MCSessionDelegate</code> protocol will be covered in the section on sending and receiving information.</p>

<h3 id="discovering">Discovering</h3>

<p>Clients can discover advertised services using <code>MCNearbyServiceBrowser</code>, which is initialized with the local peer identifier and the service type, much like for <code>MCNearbyServiceAdvertiser</code>.</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="bp">MCNearbyServiceBrowser</span> <span class="o">*</span><span class="n">browser</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">MCNearbyServiceBrowser</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithPeer</span><span class="p">:</span><span class="n">localPeerID</span> <span class="nl">serviceType</span><span class="p">:</span><span class="n">XXServiceType</span><span class="p">];</span>
<span class="n">browser</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
</code></pre></div>
<p>There may be many peers advertising a particular service, so as a convenience to the user (and the developer), the <code>MCBrowserViewController</code> offers a built-in, standard way to present and connect to advertising peers:</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="bp">MCBrowserViewController</span> <span class="o">*</span><span class="n">browserViewController</span> <span class="o">=</span>
    <span class="p">[[</span><span class="bp">MCBrowserViewController</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithBrowser</span><span class="p">:</span><span class="n">browser</span>
                                             <span class="nl">session</span><span class="p">:</span><span class="n">session</span><span class="p">];</span>
<span class="n">browserViewController</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
<span class="p">[</span><span class="nb">self</span> <span class="nl">presentViewController</span><span class="p">:</span><span class="n">browserViewController</span>
                   <span class="nl">animated</span><span class="p">:</span><span class="nb">YES</span>
                 <span class="nl">completion</span><span class="p">:</span>
<span class="o">^</span><span class="p">{</span>
    <span class="p">[</span><span class="n">browser</span> <span class="n">startBrowsingForPeers</span><span class="p">];</span>
<span class="p">}];</span>
</code></pre></div>
<p>When a browser has finished connecting to peers, it calls <code>-browserViewControllerDidFinish:</code> on its delegate, to notify the presenting view controller that it should update its UI to accommodate the newly-connected clients.</p>

<h2 id="sending-&amp;-receiving-information">Sending &amp; Receiving Information</h2>

<p>Once peers are connected to one another, information can be sent between them. The Multipeer Connectivity framework distinguishes between three different forms of data transfer:</p>

<ul>
<li><strong>Messages</strong> are information with well-defined boundaries, such as short text or small serialized objects.</li>
<li><strong>Streams</strong> are open channels of information used to continuously transfer data like audio, video, or real-time sensor events.</li>
<li><strong>Resources</strong> are files like images, movies, or documents.</li>
</ul>

<h3 id="messages">Messages</h3>

<p>Messages are sent with <code>-sendData:toPeers:withMode:error:</code>:</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="bp">NSString</span> <span class="o">*</span><span class="n">message</span> <span class="o">=</span> <span class="s">@&quot;Hello, World!&quot;</span><span class="p">;</span>
<span class="bp">NSData</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">message</span> <span class="nl">dataUsingEncoding</span><span class="p">:</span><span class="n">NSUTF8StringEncoding</span><span class="p">];</span>
<span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">session</span> <span class="nl">sendData</span><span class="p">:</span><span class="n">data</span>
                    <span class="nl">toPeers</span><span class="p">:</span><span class="n">peers</span>
                   <span class="nl">withMode</span><span class="p">:</span><span class="n">MCSessionSendDataReliable</span>
                      <span class="nl">error</span><span class="p">:</span><span class="o">&amp;</span><span class="n">error</span><span class="p">])</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;[Error] %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<hr>

<p>Messages are received through the <code>MCSessionDelegate</code> method <code>-sessionDidReceiveData:fromPeer:</code>. Here&rsquo;s how one would decode the message sent in the previous code example:</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="cp">#pragma mark - MCSessionDelegate</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">session:</span><span class="p">(</span><span class="bp">MCSession</span> <span class="o">*</span><span class="p">)</span><span class="nv">session</span>
 <span class="nf">didReceiveData:</span><span class="p">(</span><span class="bp">NSData</span> <span class="o">*</span><span class="p">)</span><span class="nv">data</span>
       <span class="nf">fromPeer:</span><span class="p">(</span><span class="bp">MCPeerID</span> <span class="o">*</span><span class="p">)</span><span class="nv">peerID</span>
<span class="p">{</span>
    <span class="bp">NSString</span> <span class="o">*</span><span class="n">message</span> <span class="o">=</span>
        <span class="p">[[</span><span class="bp">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithData</span><span class="p">:</span><span class="n">data</span>
                              <span class="nl">encoding</span><span class="p">:</span><span class="n">NSUTF8StringEncoding</span><span class="p">];</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Another approach would be to send <code>NSKeyedArchiver</code>-encoded objects:</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="kt">id</span> <span class="o">&lt;</span><span class="bp">NSSecureCoding</span><span class="o">&gt;</span> <span class="n">object</span> <span class="o">=</span> <span class="c1">// ...;</span>
<span class="bp">NSData</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSKeyedArchiver</span> <span class="nl">archivedDataWithRootObject</span><span class="p">:</span><span class="n">object</span><span class="p">];</span>
<span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">session</span> <span class="nl">sendData</span><span class="p">:</span><span class="n">data</span>
                    <span class="nl">toPeers</span><span class="p">:</span><span class="n">peers</span>
                   <span class="nl">withMode</span><span class="p">:</span><span class="n">MCSessionSendDataReliable</span>
                      <span class="nl">error</span><span class="p">:</span><span class="o">&amp;</span><span class="n">error</span><span class="p">])</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;[Error] %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="cp">#pragma mark - MCSessionDelegate</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">session:</span><span class="p">(</span><span class="bp">MCSession</span> <span class="o">*</span><span class="p">)</span><span class="nv">session</span>
 <span class="nf">didReceiveData:</span><span class="p">(</span><span class="bp">NSData</span> <span class="o">*</span><span class="p">)</span><span class="nv">data</span>
       <span class="nf">fromPeer:</span><span class="p">(</span><span class="bp">MCPeerID</span> <span class="o">*</span><span class="p">)</span><span class="nv">peerID</span>
<span class="p">{</span>
    <span class="bp">NSKeyedUnarchiver</span> <span class="o">*</span><span class="n">unarchiver</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSKeyedUnarchiver</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initForReadingWithData</span><span class="p">:</span><span class="n">data</span><span class="p">];</span>
    <span class="n">unarchiver</span><span class="p">.</span><span class="n">requiresSecureCoding</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
    <span class="kt">id</span> <span class="n">object</span> <span class="o">=</span> <span class="p">[</span><span class="n">unarchiver</span> <span class="n">decodeObject</span><span class="p">];</span>
    <span class="p">[</span><span class="n">unarchiver</span> <span class="n">finishDecoding</span><span class="p">];</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">object</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<blockquote>
<p>In order to guard against object substitution attacks, it is important to set <code>requiresSecureCoding</code> to <code>YES</code>, such that an exception is thrown if the root object class does not conform to <code>&lt;NSSecureCoding&gt;</code>.  For more information, see the [NSHipster article on <a href="http://nshipster.com/nssecurecoding/">NSSecureCoding</a>.</p>
</blockquote>

<h3 id="streams">Streams</h3>

<p>Streams are created with <code>-startStreamWithName:toPeer:</code>:</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="bp">NSOutputStream</span> <span class="o">*</span><span class="n">outputStream</span> <span class="o">=</span>
    <span class="p">[</span><span class="n">session</span> <span class="nl">startStreamWithName</span><span class="p">:</span><span class="n">name</span>
                          <span class="nl">toPeer</span><span class="p">:</span><span class="n">peer</span><span class="p">];</span>

<span class="n">stream</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
<span class="p">[</span><span class="n">stream</span> <span class="nl">scheduleInRunLoop</span><span class="p">:[</span><span class="bp">NSRunLoop</span> <span class="n">mainRunLoop</span><span class="p">]</span>
                <span class="nl">forMode</span><span class="p">:</span><span class="n">NSDefaultRunLoopMode</span><span class="p">];</span>
<span class="p">[</span><span class="n">stream</span> <span class="n">open</span><span class="p">];</span>

<span class="c1">// ...</span>
</code></pre></div>
<hr>

<p>Streams are received by the <code>MCSessionDelegate</code> with <code>-session:didReceiveStream:withName:fromPeer:</code>:</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="cp">#pragma mark - MCSessionDelegate</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">session:</span><span class="p">(</span><span class="bp">MCSession</span> <span class="o">*</span><span class="p">)</span><span class="nv">session</span>
<span class="nf">didReceiveStream:</span><span class="p">(</span><span class="bp">NSInputStream</span> <span class="o">*</span><span class="p">)</span><span class="nv">stream</span>
       <span class="nf">withName:</span><span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">streamName</span>
       <span class="nf">fromPeer:</span><span class="p">(</span><span class="bp">MCPeerID</span> <span class="o">*</span><span class="p">)</span><span class="nv">peerID</span>
<span class="p">{</span>
    <span class="n">stream</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
    <span class="p">[</span><span class="n">stream</span> <span class="nl">scheduleInRunLoop</span><span class="p">:[</span><span class="bp">NSRunLoop</span> <span class="n">mainRunLoop</span><span class="p">]</span>
                      <span class="nl">forMode</span><span class="p">:</span><span class="n">NSDefaultRunLoopMode</span><span class="p">];</span>
    <span class="p">[</span><span class="n">stream</span> <span class="n">open</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>
<p>Both the input and output streams must be scheduled and opened before they can be used. Once that&rsquo;s done, streams can be read from and written to just like any other bound pair.</p>

<h3 id="resources">Resources</h3>

<p>Resources are sent with <code>sendResourceAtURL:withName:toPeer:withCompletionHandler:</code>:</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="bp">NSURL</span> <span class="o">*</span><span class="n">fileURL</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSURL</span> <span class="nl">fileURLWithPath</span><span class="p">:</span><span class="s">@&quot;path/to/resource&quot;</span><span class="p">];</span>
<span class="bp">NSProgress</span> <span class="o">*</span><span class="n">progress</span> <span class="o">=</span>
    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">session</span> <span class="nl">sendResourceAtURL</span><span class="p">:</span><span class="n">fileURL</span>
                           <span class="nl">withName</span><span class="p">:[</span><span class="n">fileURL</span> <span class="n">lastPathComponent</span><span class="p">]</span>
                             <span class="nl">toPeer</span><span class="p">:</span><span class="n">peer</span>
                  <span class="nl">withCompletionHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;[Error] %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<span class="p">}];</span>
</code></pre></div>
<p>The returned <code>NSProgress</code> object can be <a href="http://nshipster.com/key-value-observing/">Key-Value Observed</a> to monitor progress of the file transfer, as well as provide a cancellation handler, through the <code>-cancel</code> method.</p>

<hr>

<p>Receiving resources happens across two methods in <code>MCSessionDelegate</code>: <code>-session:didStartReceivingResourceWithName:fromPeer:withProgress:</code> &amp; <code>-session:didFinishReceivingResourceWithName:fromPeer:atURL:withError:</code>:</p>
<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="cp">#pragma mark - MCSessionDelegate</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">session:</span><span class="p">(</span><span class="bp">MCSession</span> <span class="o">*</span><span class="p">)</span><span class="nv">session</span>
<span class="nf">didStartReceivingResourceWithName:</span><span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">resourceName</span>
       <span class="nf">fromPeer:</span><span class="p">(</span><span class="bp">MCPeerID</span> <span class="o">*</span><span class="p">)</span><span class="nv">peerID</span>
   <span class="nf">withProgress:</span><span class="p">(</span><span class="bp">NSProgress</span> <span class="o">*</span><span class="p">)</span><span class="nv">progress</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">session:</span><span class="p">(</span><span class="bp">MCSession</span> <span class="o">*</span><span class="p">)</span><span class="nv">session</span>
<span class="nf">didFinishReceivingResourceWithName:</span><span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">resourceName</span>
       <span class="nf">fromPeer:</span><span class="p">(</span><span class="bp">MCPeerID</span> <span class="o">*</span><span class="p">)</span><span class="nv">peerID</span>
          <span class="nf">atURL:</span><span class="p">(</span><span class="bp">NSURL</span> <span class="o">*</span><span class="p">)</span><span class="nv">localURL</span>
      <span class="nf">withError:</span><span class="p">(</span><span class="bp">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span>
<span class="p">{</span>
    <span class="bp">NSURL</span> <span class="o">*</span><span class="n">destinationURL</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSURL</span> <span class="nl">fileURLWithPath</span><span class="p">:</span><span class="s">@&quot;/path/to/destination&quot;</span><span class="p">];</span>
    <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[[</span><span class="bp">NSFileManager</span> <span class="n">defaultManager</span><span class="p">]</span> <span class="nl">moveItemAtURL</span><span class="p">:</span><span class="n">localURL</span>
                                                 <span class="nl">toURL</span><span class="p">:</span><span class="n">destinationURL</span>
                                                 <span class="nl">error</span><span class="p">:</span><span class="o">&amp;</span><span class="n">error</span><span class="p">])</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;[Error] %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Again, the <code>NSProgress</code> parameter in <code>-session:didStartReceivingResourceWithName:fromPeer:withProgress:</code> allows the receiving peer to monitor the file transfer progress. In <code>-session:didFinishReceivingResourceWithName:fromPeer:atURL:withError:</code>, it is the responsibility of the delegate to move the file at the temporary <code>localURL</code> to a permanent location.</p>

<hr>

<p>Multipeer Connectivity is a ground-breaking API, whose value is only just starting to be fully understood. Although full support for features like AirDrop are currently limited to latest-gen devices, you should expect to see this kind of functionality become expected behavior.</p>

<p>As you look forward to the possibilities of the new year ahead, get your head out of the cloud, and start to consider the incredible possibilities around you.</p>

  </div>

  <footer role="complementary">
    
    <section id="revisions">
      <small>NSMutableHipster</small>

      <p>
      Questions? Corrections?  <a href="https://github.com/NSHipster/articles/issues">Issues</a> and <a href="https://github.com/NSHipster/articles/blob/master/2013-12-09-multipeer-connectivity.md">pull requests</a> are always welcome — NSHipster is made better by readers like you.
      </p>
      
      <p>
      
            
      
      Find status information for all articles on the <a href="/status/">status page</a>.
      </p>
      
      <dl>
      
      </dl>
    </section>
    

    <section id="follow">
      <small>Follow NSHipster</small>

      <ul>
        <li class="twitter">
          <a href="https://twitter.com/intent/user?screen_name=NSHipster" title="Follow NSHipster on Twitter"><i class="icon-twitter" aria-hidden="true"></i></a>
        </li>
        <li class="facebook">
          <a href="https://www.facebook.com/NSHipster" title="Like NSHipster on Facebook"><i class="icon-facebook" aria-hidden="true"></i></a>
        </li>
        <li class="google-plus">
          <a href="https://plus.google.com/+NSHipster" title="Follow NSHipster on G+"><i class="icon-googleplus" aria-hidden="true"></i></a>
        </li>
        <li class="rss">
          <a href="/feed.xml" title="Subscribe to the NSHipster RSS Feed"><i class="icon-feed" aria-hidden="true"></i></a>
        </li>
      </ul>

      <form action="https://tinyletter.com/NSHipster" method="post" target="popupwindow" onsubmit="window.open('https://tinyletter.com/NSHipster', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true">
        <label for="tlemail" hidden style="display:none;">Enter Your Email Address</label>
        <input type="email" name="email" id="tlemail" placeholder="Your Email Address"/>
        <input type="hidden" name="embed" value="1"/>
        <input type="submit" value="Join the Newsletter"/>
      </form>
    </section>

    <section id="attribution">
      
  <div class="contributor" itemprop="author" itemscope itemtype="http://data-vocabulary.org/Person">
    <small>Written by</small>

    <img class="avatar" alt="Mattt Thompson" itemprop="image" src="http://nshipster.s3.amazonaws.com/mattt-thompson.jpg" draggable="false"/>
    <div class="details">
      <span itemprop="name"><a href="/authors/mattt-thompson/">Mattt Thompson</a></span>

      <p><a href="https://github.com/mattt">Mattt Thompson</a> (<a href="https://twitter.com/mattt">@mattt</a>) is a writer and developer from the Rustbelt.</p>


      
        <a href="https://plus.google.com/106751358503565042647?rel=author" rel="author"></a>
      
    </div>
  </div>


    </section>

    

    

    <section>
      <div id="continue">
        <small>Next Article</small>
        
        

          <article>
            <h1 class="title">
              <a href="/launch-options/" title="UIApplicationDelegate launchOptions" rel="next">UIApplication​Delegate launch​Options</a>
            </h1>

            <p>AppDelegate is the dumping ground for functionality in iOS.</p>

          </article>
      </div>

      
      
        
        
      

      <div id="related">
        <small>Related Articles</small>

        <ul>
          
          
          
            <li>
              <a href="/javascriptcore/" title="JavaScriptCore">JavaScriptCore</a>
            </li>
            
          
          
            <li>
              <a href="/nsundomanager/" title="NSUndoManager">NSUndoManager</a>
            </li>
            
          
          
            <li>
              <a href="/wkwebkit/" title="WKWebView">WKWebView</a>
            </li>
            
          
          
            <li>
              <a href="/nsassertionhandler/" title="NSAssertionHandler">NSAssertionHandler</a>
            </li>
            
          
        </ul>
      </div>
    </section>
  </footer>
</article>

    </div>

    <footer role="contentinfo">
      <section class="credits colophon">
        <p>
          Questions? Corrections? <a href="https://twitter.com/NSHipster">@NSHipster</a> or <a href="https://github.com/NSHipster/articles">on GitHub</a>.
        </p>
        <p>
          <i aria-hidden="true" class="icon-cc"></i>
          <i aria-hidden="true" class="icon-cc-by"></i>
          <i aria-hidden="true" class="icon-cc-nc"></i>
          NSHipster.com is released under a <a href="http://creativecommons.org/licenses/by-nc/4.0/" rel="license">Creative Commons BY-NC License</a>.
        </p>
        <p><abbr title="International Standard Serial Number">ISSN</abbr> 2373-9800</p>
        <p lang="zh-Hans"><a href="http://nshipster.cn" hreflang="zh-Hans" title="Articles also available in Chinese">文章也可在中文版阅读</a>。</p>
        <a href="https://plus.google.com/105091289906267717942" rel="publisher"></a>
      </section>
    </footer>
  </div>

  <script>
    if (window.navigator && window.navigator.loadPurpose === "preview") {
      window.location.href = "http://nshipster.com/topsites_preview.html";
    }
  </script>

  <script async>
    var Swiftype = window.Swiftype || {};
    (function() {
      Swiftype.key = 'Q5jNBiR8qVs5xE5dNect';
      var script = document.createElement('script');
      script.type = 'text/javascript';
      script.async = true;
      script.src = "//swiftype.com/embed.js";
      var entry = document.getElementsByTagName('script')[0];
      document.getElementsByTagName('script')[0].parentNode.insertBefore(script, entry);
    }());
  </script>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-49868484-1', 'nshipster.com');
    ga('send', 'pageview');
  </script>

</body>
</html>
